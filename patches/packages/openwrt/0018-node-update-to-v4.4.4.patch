From: Matthias Schiffer <mschiffer@universe-factory.net>
Date: Mon, 9 May 2016 15:57:18 +0200
Subject: node: update to v4.4.4

While we're at it, also enable parallel builds.

Signed-off-by: Matthias Schiffer <mschiffer@universe-factory.net>

diff --git a/lang/node/Makefile b/lang/node/Makefile
index 37da18ce83285882208fc303a9c29bd64f279042..a95aecb3aca1e52e29e4f151ffd28ef361bf1336 100644
--- a/lang/node/Makefile
+++ b/lang/node/Makefile
@@ -8,17 +8,21 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=node
-PKG_VERSION:=v0.12.13
+PKG_VERSION:=v4.4.4
 PKG_RELEASE:=1
 
-PKG_SOURCE:=node-$(PKG_VERSION).tar.gz
+PKG_SOURCE:=node-$(PKG_VERSION).tar.xz
 PKG_SOURCE_URL:=http://nodejs.org/dist/${PKG_VERSION}
+PKG_MD5SUM:=1ad7915688df85f62a57f43860dc54c6
 
 HOST_BUILD_DEPENDS:=python/host
 PKG_BUILD_DEPENDS:=python/host
 PKG_INSTALL:=1
 PKG_USE_MIPS16:=0
 
+HOST_BUILD_PARALLEL:=1
+PKG_BUILD_PARALLEL:=1
+
 PKG_MAINTAINER:=John Crispin <blogic@openwrt.org>
 PKG_LICENSE:=
 
@@ -31,7 +35,7 @@ define Package/node
   SUBMENU:=Node.js
   TITLE:=Node.js is a platform built on Chrome's JavaScript runtime
   URL:=http://nodejs.org/
-  DEPENDS:=+libpthread +librt +libstdcpp +libopenssl +libuv
+  DEPENDS:=+libpthread +librt +libstdcpp +libopenssl +libuv +zlib
 endef
 
 define Package/node/description
diff --git a/lang/node/patches/001-hardfloat.patch b/lang/node/patches/001-hardfloat.patch
new file mode 100644
index 0000000000000000000000000000000000000000..1bb24930f39e5972df72e49371994bc2debe78f6
--- /dev/null
+++ b/lang/node/patches/001-hardfloat.patch
@@ -0,0 +1,12 @@
+diff --git a/deps/v8/src/base/cpu.cc b/deps/v8/src/base/cpu.cc
+index 4f58720..1f3071e 100644
+--- a/deps/v8/src/base/cpu.cc
++++ b/deps/v8/src/base/cpu.cc
+@@ -143,6 +143,7 @@ int __detect_fp64_mode(void) {
+       ".set push\n\t"
+       ".set noreorder\n\t"
+       ".set oddspreg\n\t"
++      ".set hardfloat\n\t"
+       "lui $t0, 0x3FF0\n\t"
+       "ldc1 $f0, %0\n\t"
+       "mtc1 $t0, $f1\n\t"
diff --git a/lang/node/patches/001-mips-no-fpu.patch b/lang/node/patches/001-mips-no-fpu.patch
deleted file mode 100644
index 5bf8142ccaea10523419412940e52e036a2f8735..0000000000000000000000000000000000000000
--- a/lang/node/patches/001-mips-no-fpu.patch
+++ /dev/null
@@ -1,15 +0,0 @@
---- a/deps/v8/build/toolchain.gypi
-+++ b/deps/v8/build/toolchain.gypi
-@@ -50,10 +50,10 @@
-     'arm_test_noprobe%': 'off',
- 
-     # Similar to vfp but on MIPS.
--    'v8_can_use_fpu_instructions%': 'true',
-+    'v8_can_use_fpu_instructions%': 'false',
- 
-     # Similar to the ARM hard float ABI but on MIPS.
--    'v8_use_mips_abi_hardfloat%': 'true',
-+    'v8_use_mips_abi_hardfloat%': 'false',
- 
-     # Default arch variant for MIPS.
-     'mips_arch_variant%': 'r2',
diff --git a/lang/node/patches/002-addr_info.patch b/lang/node/patches/002-addr_info.patch
index 78225db55b9c96ac60a1d55478aecbfdec80abc9..0aa02dac231eee5ed15aff9710aa0d40990b3a60 100644
--- a/lang/node/patches/002-addr_info.patch
+++ b/lang/node/patches/002-addr_info.patch
@@ -1,6 +1,6 @@
 --- a/deps/uv/src/unix/getaddrinfo.c
 +++ b/deps/uv/src/unix/getaddrinfo.c
-@@ -99,6 +99,7 @@
+@@ -99,6 +99,7 @@ static void uv__getaddrinfo_work(struct
    int err;
  
    req = container_of(w, uv_getaddrinfo_t, work_req);
diff --git a/lang/node/patches/003-path.patch b/lang/node/patches/003-path.patch
index 723fe9da7dbcbcd0e1e8c7278100f68440462e57..01a71c6a31a76987a2eae706912f58b6d08344d8 100644
--- a/lang/node/patches/003-path.patch
+++ b/lang/node/patches/003-path.patch
@@ -1,7 +1,7 @@
 --- a/lib/module.js
 +++ b/lib/module.js
-@@ -512,7 +512,8 @@
-     var homeDir = process.env.HOME;
+@@ -453,7 +453,8 @@ Module._initPaths = function() {
+     homeDir = process.env.HOME;
    }
  
 -  var paths = [path.resolve(process.execPath, '..', '..', 'lib', 'node')];
